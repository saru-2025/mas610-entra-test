name: ğŸš€ Deploy to Test ADF & Databricks

on:
  workflow_dispatch:

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: ğŸ§© Checkout Test repo
        uses: actions/checkout@v4

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            }

      # âœ… Deploy ADF template using ARM Deploy Action
      - name: ğŸš€ Deploy Azure Data Factory ARM Template
        uses: Azure/arm-deploy@v1
        with:
          scope: resourcegroup
          resourceGroupName: rg_data_platform_test
          template: factory/adf-data-platform-test.json
          parameters: factory/arm-template-parameters.json
          deploymentName: adf-test-deployment
          failOnStdErr: false

      # âš™ï¸ Install Databricks CLI
      - name: âš™ï¸ Install Databricks CLI
        run: pip install databricks-cli

      # ğŸ”‘ Configure Databricks CLI
      - name: ğŸ”‘ Configure Databricks
        run: |
          databricks configure --token <<EOF
          ${{ secrets.DATABRICKS_HOST }}
          ${{ secrets.DATABRICKS_TOKEN }}
          EOF

      # ğŸ“¦ Upload Notebooks
      - name: ğŸ“¦ Upload Notebooks to Test Workspace
        run: |
          echo "Uploading notebooks to Test workspace..."
          databricks workspace import_dir notebooks /Shared/Test_Notebooks --overwrite
